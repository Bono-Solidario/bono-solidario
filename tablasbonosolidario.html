<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Bono Solidario</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #000000;
      background-image: 
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png'),
        url('https://i.ibb.co/B5KwNjP6/logobonosolidariosinfondo.png');
      background-size: 
        200px 200px, 
        80px 80px, 
        250px 250px, 
        120px 120px,
        180px 180px,
        60px 60px,
        160px 160px,
        100px 100px,
        220px 220px,
        90px 90px,
        140px 140px,
        70px 70px,
        190px 190px,
        110px 110px;
      background-position: 
        10% 20%, 
        80% 70%, 
        30% 90%, 
        90% 10%,
        5% 60%,
        70% 5%,
        20% 45%,
        95% 85%,
        45% 15%,
        15% 80%,
        60% 35%,
        85% 50%,
        35% 65%,
        55% 95%;
      background-repeat: no-repeat;
      margin: 0;
      padding: 10px;
      color: #f0f4f8;
      min-height: 100vh;
      user-select: none;
      -webkit-user-select: none;
      position: relative;
      overflow-x: hidden;
      overflow-y: auto;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      z-index: -1;
    }

    .title-container {
      text-align: center;
      margin-bottom: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      border-radius: 20px;
      border: 2px solid #4a5568;
      box-shadow: 
        0 8px 32px rgba(255,255,255,0.1),
        inset 0 1px 0 rgba(255,255,255,0.1);
    }

    .title-glow {
      font-size: clamp(1.8rem, 5vw, 3.5rem);
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: clamp(1px, 0.5vw, 3px);
      color: #ffffff;
      text-shadow: 0 4px 8px rgba(0,0,0,0.5);
      margin: 0;
      filter: drop-shadow(0 2px 4px rgba(255,255,255,0.1));
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
      gap: 15px;
      flex-wrap: wrap;
    }

    .board-selector {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .board-btn {
      padding: 15px 30px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      border: none;
      border-radius: 15px;
      font-weight: 700;
      font-size: clamp(14px, 2.5vw, 16px);
      cursor: pointer;
      transition: all 0.3s ease;
      min-height: 50px;
      box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
      text-transform: uppercase;
      letter-spacing: 1px;
      -webkit-appearance: none;
      appearance: none;
    }

    .board-btn.active {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
      transform: scale(1.05);
    }

    .board-btn:hover, .board-btn:active {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
    }

    .board-btn.active:hover, .board-btn.active:active {
      box-shadow: 0 8px 25px rgba(39, 174, 96, 0.5);
    }

    select, button {
      padding: 12px 20px;
      font-size: clamp(14px, 2.5vw, 16px);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      min-height: 44px;
      -webkit-appearance: none;
      appearance: none;
    }

    select {
      background: #ffffff;
      color: #2c3e50;
      box-shadow: 0 4px 15px rgba(255,255,255,0.1);
      border: 1px solid #e2e8f0;
    }

    button {
      background: #4a5568;
      color: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    button:hover, button:active {
      background: #5a6578;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }

    .grid-container {
      background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85));
      padding: clamp(8px, 2vw, 15px);
      border-radius: 20px;
      border: 2px solid #4a5568;
      box-shadow: 0 8px 32px rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: clamp(2px, 1vw, 6px);
    }

    .board1 .cell {
      position: relative;
      width: 100%;
      padding-top: 100%;
      background: linear-gradient(135deg, #0d7377, #14a085);
      border-radius: clamp(6px, 1.5vw, 12px);
      box-shadow: 
        0 4px 15px rgba(13, 115, 119, 0.5),
        inset 0 1px 0 rgba(255,255,255,0.2);
      text-align: center;
      font-weight: 800;
      color: #ffffff;
      cursor: pointer;
      transition: all 0.3s ease;
      overflow: hidden;
      border: 3px solid #2d9687;
      -webkit-touch-callout: none;
      user-select: none;
      -webkit-user-select: none;
    }

    .board1 .cell:hover, .board1 .cell:active {
      transform: scale(1.05) rotate(2deg);
      box-shadow: 
        0 8px 25px rgba(13, 115, 119, 0.7),
        0 0 20px rgba(13, 115, 119, 0.6);
      background: linear-gradient(135deg, #2d9687, #0d7377);
    }

    .board2 .cell {
      position: relative;
      width: 100%;
      padding-top: 100%;
      background: linear-gradient(135deg, #6a1b9a, #8e44ad);
      border-radius: clamp(6px, 1.5vw, 12px);
      box-shadow: 
        0 4px 15px rgba(106, 27, 154, 0.5),
        inset 0 1px 0 rgba(255,255,255,0.2);
      text-align: center;
      font-weight: 800;
      color: #ffffff;
      cursor: pointer;
      transition: all 0.3s ease;
      overflow: hidden;
      border: 3px solid #9c4dcc;
      -webkit-touch-callout: none;
      user-select: none;
      -webkit-user-select: none;
    }

    .board2 .cell:hover, .board2 .cell:active {
      transform: scale(1.05) rotate(-2deg);
      box-shadow: 
        0 8px 25px rgba(106, 27, 154, 0.7),
        0 0 20px rgba(106, 27, 154, 0.6);
      background: linear-gradient(135deg, #9c4dcc, #6a1b9a);
    }

    .cell-content {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(1.2rem, 3.5vw, 2.2rem);
      font-weight: 900;
      z-index: 1;
      color: #ffffff;
      background: rgba(0, 0, 0, 0.4);
      border-radius: inherit;
      text-shadow: 0 2px 8px rgba(0,0,0,0.9);
      backdrop-filter: blur(1px);
      -webkit-backdrop-filter: blur(1px);
    }

    .cell img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 1;
      pointer-events: none;
      z-index: 2;
      border-radius: clamp(6px, 1.5vw, 10px);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
    }

    .selection-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }

    .selection-list {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      padding: clamp(12px, 3vw, 20px);
      border-radius: 15px;
      border: 2px solid #4a5568;
      box-shadow: 0 8px 32px rgba(255,255,255,0.1);
      display: none;
    }

    .selection-list.active {
      display: block;
    }

    .selection-list h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #ffffff;
      font-weight: 700;
      font-size: clamp(1rem, 3vw, 1.2rem);
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .selection-items {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: clamp(120px, 25vh, 200px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .selection-items li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      font-weight: 600;
      font-size: clamp(0.9rem, 2.5vw, 1rem);
      color: #f0f4f8;
    }

    .selection-items li:last-child {
      border-bottom: none;
    }

    .tabla1-list {
      border-left: 4px solid #14a085;
    }

    .tabla2-list {
      border-left: 4px solid #8e44ad;
    }

    /* Modal personalizado para iOS */
    .ios-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .ios-modal.show {
      display: flex;
    }

    .ios-modal-content {
      background: #fff;
      border-radius: 15px;
      padding: 25px;
      max-width: 350px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    .ios-modal h3 {
      color: #333;
      margin: 0 0 15px 0;
      font-size: 18px;
      font-weight: 600;
    }

    .ios-modal p {
      color: #666;
      margin: 0 0 20px 0;
      font-size: 14px;
      line-height: 1.4;
    }

    .ios-modal input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 20px;
      box-sizing: border-box;
    }

    .ios-modal-buttons {
      display: flex;
      gap: 10px;
    }

    .ios-modal button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ios-modal .btn-cancel {
      background: #f0f0f0;
      color: #666;
    }

    .ios-modal .btn-confirm {
      background: #007AFF;
      color: white;
    }

    .ios-modal .btn-delete {
      background: #FF3B30;
      color: white;
    }

    .ios-modal .btn-edit {
      background: #FF9500;
      color: white;
    }

    @media (max-width: 768px) {
      body {
        padding: 8px;
        background-size: 
          120px 120px, 
          90px 90px, 
          140px 140px, 
          80px 80px,
          110px 110px,
          85px 85px,
          100px 100px,
          70px 70px;
      }
      
      .title-container {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .controls {
        flex-direction: column;
        gap: 10px;
        margin-bottom: 15px;
      }
      
      .board-selector {
        flex-direction: row;
        gap: 10px;
        margin-bottom: 15px;
      }
      
      .board-btn {
        flex: 1;
        padding: 12px;
        min-height: 45px;
      }
      
      select, button {
        width: 100%;
        padding: 12px;
        min-height: 45px;
        font-size: 16px !important;
      }
      
      .grid-container {
        margin-bottom: 15px;
      }

      .cell-content {
        font-size: clamp(1rem, 4vw, 1.8rem);
        background: rgba(0, 0, 0, 0.5);
        text-shadow: 0 2px 6px rgba(0,0,0,1);
      }

      .selection-container {
        margin-top: 15px;
        gap: 12px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 5px;
        background-size: 
          100px 100px, 
          70px 70px, 
          120px 120px, 
          60px 60px,
          90px 90px,
          65px 65px,
          80px 80px,
          55px 55px;
      }

      .title-container {
        padding: 12px;
        margin-bottom: 12px;
      }

      .board-selector {
        gap: 8px;
        margin-bottom: 12px;
      }

      .controls {
        gap: 8px;
        margin-bottom: 12px;
      }
      
      .cell-content {
        font-size: clamp(0.9rem, 4.5vw, 1.6rem);
        background: rgba(0, 0, 0, 0.6);
        text-shadow: 0 2px 6px rgba(0,0,0,1);
      }
      
      .grid-container {
        margin-bottom: 12px;
      }

      .selection-container {
        margin-top: 12px;
        gap: 10px;
      }
    }

    @media (max-width: 360px) {
      body {
        background-size: 
          80px 80px, 
          60px 60px, 
          100px 100px, 
          50px 50px,
          70px 70px,
          55px 55px,
          65px 65px,
          45px 45px;
      }

      .cell-content {
        font-size: clamp(0.8rem, 5vw, 1.4rem);
        background: rgba(0, 0, 0, 0.7);
        text-shadow: 0 2px 4px rgba(0,0,0,1);
      }
    }

    @media (max-width: 320px) {
      body {
        background-size: 
          80px 80px, 
          35px 35px, 
          120px 120px, 
          50px 50px,
          70px 70px,
          30px 30px,
          65px 65px,
          45px 45px,
          90px 90px,
          40px 40px,
          60px 60px,
          32px 32px,
          75px 75px,
          55px 55px;
      }

      .cell-content {
        font-size: clamp(0.75rem, 5.5vw, 1.2rem);
        background: rgba(0, 0, 0, 0.8);
        text-shadow: 0 1px 3px rgba(0,0,0,1);
      }
    }

    @media screen and (max-device-width: 812px) {
      .cell-content {
        font-size: clamp(0.9rem, 4vw, 1.6rem);
        line-height: 1;
        background: rgba(0, 0, 0, 0.5);
      }
    }

    @media screen and (min-width: 768px) and (max-width: 1024px) {
      .cell-content {
        font-size: clamp(1.2rem, 3vw, 2rem);
      }
    }

    @media screen and (min-width: 1200px) {
      .cell-content {
        font-size: clamp(1.8rem, 2.5vw, 2.2rem);
      }
    }

    /* Estilos específicos para iOS Safari */
    @supports (-webkit-touch-callout: none) {
      .cell {
        -webkit-touch-callout: none;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }

      button, select, .board-btn {
        -webkit-appearance: none;
        appearance: none;
        border-radius: 12px;
        touch-action: manipulation;
      }
    }

    @media screen and (-webkit-min-device-pixel-ratio: 0) {
      select {
        background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%23666' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 12px;
        padding-right: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title-container">
      <h1 class="title-glow">BONO SOLIDARIO</h1>
    </div>

    <div class="board-selector">
      <button class="board-btn active" data-board="board1">Tabla 1</button>
      <button class="board-btn" data-board="board2">Tabla 2</button>
    </div>

    <div class="controls">
      <button onclick="clearCurrentBoard()">Limpiar tablero</button>
    </div>

    <div class="grid-container">
      <div class="grid board1" id="grid"></div>
    </div>

    <div class="selection-container">
      <div class="selection-list tabla1-list active" id="tabla1List">
        <h3>Selecciones de Tabla 1</h3>
        <ul class="selection-items" id="tabla1Items"></ul>
      </div>

      <div class="selection-list tabla2-list" id="tabla2List">
        <h3>Selecciones de Tabla 2</h3>
        <ul class="selection-items" id="tabla2Items"></ul>
      </div>
    </div>
  </div>

  <!-- Modal personalizado para iOS -->
  <div class="ios-modal" id="iosModal">
    <div class="ios-modal-content">
      <h3 id="modalTitle">Título</h3>
      <p id="modalMessage">Mensaje</p>
      <input type="text" id="modalInput" style="display: none;" placeholder="Introduce el nombre...">
      <div class="ios-modal-buttons" id="modalButtons">
        <!-- Los botones se generan dinámicamente -->
      </div>
    </div>
  </div>

  <script>
    const IMAGE_URL = "https://i.ibb.co/k2KV9dTr/Copia-de-Logo-fondobicolor-Verde.png";
    const grid = document.getElementById("grid");
    const tabla1Items = document.getElementById("tabla1Items");
    const tabla2Items = document.getElementById("tabla2Items");
    const tabla1List = document.getElementById("tabla1List");
    const tabla2List = document.getElementById("tabla2List");
    const iosModal = document.getElementById("iosModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalMessage = document.getElementById("modalMessage");
    const modalInput = document.getElementById("modalInput");
    const modalButtons = document.getElementById("modalButtons");

    let boards = { "tabla1": [], "tabla2": [] };
    let currentBoard = localStorage.getItem("currentBoard") || "tabla1";
    let currentBoardType = localStorage.getItem("currentBoardType") || "board1";
    
    // Cargar datos guardados
    const savedBoards = localStorage.getItem("boards");
    if (savedBoards) {
      try {
        const parsed = JSON.parse(savedBoards);
        if (parsed.tabla1) boards.tabla1 = parsed.tabla1;
        if (parsed.tabla2) boards.tabla2 = parsed.tabla2;
      } catch (e) {
        console.error("Error al cargar datos:", e);
      }
    }

    // Función mejorada para detectar iOS
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
            (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }

    // Modal personalizado para iOS
    function showIOSModal(type, options) {
      return new Promise((resolve, reject) => {
        modalTitle.textContent = options.title;
        modalMessage.textContent = options.message;
        modalInput.style.display = options.showInput ? 'block' : 'none';
        
        if (options.showInput) {
          modalInput.value = options.defaultValue || '';
          modalInput.placeholder = options.placeholder || 'Introduce el nombre...';
        }

        modalButtons.innerHTML = '';

        if (type === 'add' || type === 'edit') {
          modalButtons.innerHTML = `
            <button class="btn-cancel" onclick="closeIOSModal(null)">Cancelar</button>
            <button class="btn-confirm" onclick="closeIOSModal('confirm')">Confirmar</button>
          `;
        } else if (type === 'editDelete') {
          modalButtons.innerHTML = `
            <button class="btn-cancel" onclick="closeIOSModal(null)">Cancelar</button>
            <button class="btn-edit" onclick="closeIOSModal('edit')">Editar</button>
            <button class="btn-delete" onclick="closeIOSModal('delete')">Eliminar</button>
          `;
        } else if (type === 'confirm') {
          modalButtons.innerHTML = `
            <button class="btn-cancel" onclick="closeIOSModal(null)">Cancelar</button>
            <button class="btn-delete" onclick="closeIOSModal('confirm')">Confirmar</button>
          `;
        }

        iosModal.classList.add('show');
        
        if (options.showInput) {
          setTimeout(() => {
            modalInput.focus();
          }, 100);
        }

        window.modalResolve = resolve;
      });
    }

    function closeIOSModal(result) {
      iosModal.classList.remove('show');
      if (window.modalResolve) {
        if (result === 'confirm' && modalInput.style.display === 'block') {
          window.modalResolve({ result, value: modalInput.value.trim() });
        } else {
          window.modalResolve({ result, value: null });
        }
        window.modalResolve = null;
      }
    }

    // Función mejorada para prompts y confirmaciones
    async function customPrompt(message, defaultValue = '') {
      if (isIOS()) {
        const response = await showIOSModal('add', {
          title: 'Introduce un nombre',
          message: message,
          showInput: true,
          defaultValue: defaultValue,
          placeholder: 'Nombre...'
        });
        return response.result === 'confirm' ? response.value : null;
      } else {
        return prompt(message, defaultValue);
      }
    }

    async function customConfirm(message) {
      if (isIOS()) {
        const response = await showIOSModal('confirm', {
          title: 'Confirmar',
          message: message,
          showInput: false
        });
        return response.result === 'confirm';
      } else {
        return confirm(message);
      }
    }

    async function customEditDeletePrompt(number, currentName) {
      if (isIOS()) {
        const response = await showIOSModal('editDelete', {
          title: `Número ${number}`,
          message: `Nombre actual: ${currentName}\n\n¿Qué quieres hacer?`,
          showInput: false
        });
        return response.result;
      } else {
        const action = confirm(
          `Número ${number} - ${currentName}\n\n` +
          `¿Quieres editar? Presiona "Aceptar"\n` +
          `¿Quieres eliminar número? Presiona "Cancelar"`
        );
        return action ? 'edit' : 'delete';
      }
    }

    // Función corregida para cambio de tablero
    function switchBoard(boardType) {
      currentBoardType = boardType;
      currentBoard = boardType === 'board1' ? 'tabla1' : 'tabla2';
      localStorage.setItem("currentBoardType", currentBoardType);
      localStorage.setItem("currentBoard", currentBoard);
      
      // Actualizar botones activos
      document.querySelectorAll('.board-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[data-board="${boardType}"]`).classList.add('active');
      
      grid.className = `grid ${boardType}`;
      updateVisibleSelectionList();
      renderGrid();
    }

    // Event listeners para los botones de tablero
    document.querySelectorAll('.board-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const boardType = this.getAttribute('data-board');
        switchBoard(boardType);
      });
    });

    function updateVisibleSelectionList() {
      if (currentBoard === 'tabla1') {
        tabla1List.classList.add('active');
        tabla2List.classList.remove('active');
      } else {
        tabla1List.classList.remove('active');
        tabla2List.classList.add('active');
      }
    }

    async function renderGrid() {
      grid.innerHTML = "";
      const selected = boards[currentBoard] || [];

      for (let i = 0; i < 100; i++) {
        const displayNumber = i.toString().padStart(2, '0');
        const cell = document.createElement("div");
        cell.className = "cell";

        const content = document.createElement("div");
        content.className = "cell-content";
        content.textContent = displayNumber;
        cell.appendChild(content);

        const isSelected = selected.some(item => item.number === displayNumber);
        
        if (isSelected) {
          const img = document.createElement("img");
          img.src = IMAGE_URL;
          img.onerror = function() {
            console.warn("Error cargando imagen:", IMAGE_URL);
          };
          cell.appendChild(img);
        }

        cell.addEventListener("click", async () => {
          try {
            if (isSelected) {
              const selectedItem = selected.find(item => item.number === displayNumber);
              const currentName = selectedItem ? selectedItem.name : '';
              
              const action = await customEditDeletePrompt(displayNumber, currentName);
              
              if (action === 'edit') {
                const newName = await customPrompt(`Editar nombre para el número ${displayNumber}:`, currentName);
                if (newName && newName.trim() && newName.trim() !== currentName) {
                  const itemIndex = selected.findIndex(item => item.number === displayNumber);
                  if (itemIndex !== -1) {
                    selected[itemIndex].name = newName.trim();
                    boards[currentBoard] = selected;
                    saveBoards();
                    renderGrid();
                    renderCurrentSelectionList();
                  }
                }
              } else if (action === 'delete') {
                const confirmDelete = await customConfirm(`¿Estás seguro de que quieres eliminar el número ${displayNumber}?`);
                if (confirmDelete) {
                  const newSelected = selected.filter(item => item.number !== displayNumber);
                  boards[currentBoard] = newSelected;
                  saveBoards();
                  renderGrid();
                  renderCurrentSelectionList();
                }
              }
            } else {
              const name = await customPrompt(`Introduce un nombre para el número ${displayNumber}:`);
              if (name && name.trim()) {
                selected.push({ number: displayNumber, name: name.trim() });
                boards[currentBoard] = selected;
                saveBoards();
                renderGrid();
                renderCurrentSelectionList();
              }
            }
          } catch (error) {
            console.error("Error en manejo de celda:", error);
          }
        });

        grid.appendChild(cell);
      }
    }

    function renderCurrentSelectionList() {
      if (currentBoard === 'tabla1') {
        renderSelectionList("tabla1", tabla1Items);
      } else {
        renderSelectionList("tabla2", tabla2Items);
      }
    }

    function renderSelectionList(boardKey, container) {
      const selected = boards[boardKey] || [];
      container.innerHTML = "";
      
      if (selected.length === 0) {
        const li = document.createElement("li");
        li.textContent = "No hay selecciones aún";
        li.style.fontStyle = "italic";
        li.style.color = "#999";
        container.appendChild(li);
      } else {
        selected
          .sort((a, b) => a.number.localeCompare(b.number))
          .forEach(({ number, name }) => {
            const li = document.createElement("li");
            li.textContent = `#${number} - ${name}`;
            container.appendChild(li);
          });
      }
    }

    function saveBoards() {
      try {
        localStorage.setItem("boards", JSON.stringify(boards));
        localStorage.setItem("currentBoard", currentBoard);
        localStorage.setItem("currentBoardType", currentBoardType);
        
        const backup = {
          boards: boards,
          timestamp: new Date().toISOString(),
          version: "1.0"
        };
        localStorage.setItem("bonoSolidarioBackup", JSON.stringify(backup));
      } catch (error) {
        console.error("Error al guardar datos:", error);
      }
    }

    async function clearCurrentBoard() {
      const tableName = currentBoard === 'tabla1' ? 'Tabla 1' : 'Tabla 2';
      const confirmClear = await customConfirm(`¿Seguro que quieres limpiar todas las selecciones de ${tableName}?`);
      if (!confirmClear) return;

      boards[currentBoard] = [];
      saveBoards();
      renderGrid();
      renderCurrentSelectionList();
      console.log(`Tablero ${tableName} limpiado manualmente por el usuario`);
    }

    function recoverDataFromBackup() {
      const backup = localStorage.getItem("bonoSolidarioBackup");
      if (backup) {
        try {
          const parsedBackup = JSON.parse(backup);
          if (parsedBackup.boards) {
            boards = parsedBackup.boards;
            saveBoards();
            renderGrid();
            renderCurrentSelectionList();
            console.log("Datos recuperados desde respaldo:", parsedBackup.timestamp);
            return true;
          }
        } catch (error) {
          console.error("Error al recuperar respaldo:", error);
        }
      }
      return false;
    }

    function verifyDataIntegrity() {
      const mainData = localStorage.getItem("boards");
      const backup = localStorage.getItem("bonoSolidarioBackup");
      
      if (!mainData && backup) {
        console.log("Datos principales perdidos, recuperando desde respaldo...");
        recoverDataFromBackup();
      }
    }

    // Cerrar modal al hacer clic fuera de él
    iosModal.addEventListener('click', function(e) {
      if (e.target === iosModal) {
        closeIOSModal(null);
      }
    });

    // Inicialización
    verifyDataIntegrity();
    
    if (currentBoardType === 'board1') {
      currentBoard = 'tabla1';
    } else {
      currentBoard = 'tabla2';
    }

    // Configurar estado inicial de botones
    document.querySelectorAll('.board-btn').forEach(btn => btn.classList.remove('active'));
    const activeButton = document.querySelector(`[data-board="${currentBoardType}"]`);
    if (activeButton) {
      activeButton.classList.add('active');
    }
    
    grid.className = `grid ${currentBoardType}`;
    updateVisibleSelectionList();
    renderGrid();
    renderCurrentSelectionList();

    console.log("App inicializada correctamente para dispositivo:", isIOS() ? 'iOS' : 'otros');
  </script>
</body>
</html>